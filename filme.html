<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gerenciamento de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1E40AF',
                        'secondary': '#3B82F6',
                        'accent': '#DBEAFE'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4" onload="carregarPedidos()">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl mx-auto transition-all duration-300">
        <h1 class="text-3xl font-bold mb-6 text-center text-primary">Painel de Gerenciamento de Pedidos</h1>
        <div id="listaPedidos" class="space-y-6"></div>
        <div id="errorMessage" class="mt-6 text-red-500 hidden text-center font-medium"></div>
    </div>

    <script>
        const TMDB_API_KEY = 'a0830843cc828e9adb00d378f700e585';

        async function carregarPedidos() {
            const listaPedidosElement = document.getElementById('listaPedidos');
            const errorMessage = document.getElementById('errorMessage');

            try {
                const response = await fetch('https://66d39f5c184dce1713d09736.mockapi.io/Api/v1/clientes');
                if (!response.ok) {
                    throw new Error('Falha ao buscar dados da API.');
                }
                const clients = await response.json();

                let html = '';
                for (const client of clients) {
                    const pedidos = client.pedidos || [];
                    if (pedidos.length === 0) continue;

                    // Normalizar n√∫mero do WhatsApp para o link do WhatsApp
                    const normalizedWhatsApp = client.whats.replace(/[\s\-\(\)+]/g, '');
                    html += `
                        <div class="border-b pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-semibold text-primary">${client.cliente}</h2>
                                <div class="flex items-center space-x-2">
                                    <p class="text-sm text-gray-500">${client.whats}</p>
                                    <button onclick="window.open('https://wa.me/${normalizedWhatsApp}', '_blank')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition duration-200">Enviar Mensagem</button>
                                </div>
                            </div>
                            <div class="space-y-4">
                    `;

                    for (const pedido of pedidos) {
                        let posterUrl = 'https://via.placeholder.com/100x150?text=Sem+Poster';
                        if (pedido.tmdb_id && pedido.media_type) {
                            try {
                                const endpoint = pedido.media_type === 'movie' ? `/movie/${pedido.tmdb_id}` : `/tv/${pedido.tmdb_id}`;
                                const imgResponse = await fetch(`https://api.themoviedb.org/3${endpoint}?api_key=${TMDB_API_KEY}&language=pt-BR`);
                                if (imgResponse.ok) {
                                    const imgData = await imgResponse.json();
                                    if (imgData.poster_path) {
                                        posterUrl = `https://image.tmdb.org/t/p/w200${imgData.poster_path}`;
                                    }
                                }
                            } catch (error) {
                                console.error(`Erro ao buscar poster para pedido ${pedido.id}:`, error);
                            }
                        }
                        html += `
                            <div class="bg-gray-50 p-4 rounded-lg border flex space-x-4 items-center">
                                <img src="${posterUrl}" alt="${pedido.conteudo}" class="w-16 h-24 object-cover rounded">
                                <div class="flex-1">
                                    <p class="font-medium">${pedido.conteudo}</p>
                                    <p class="text-sm text-gray-500">Data: ${new Date(pedido.data).toLocaleDateString('pt-BR')}</p>
                                </div>
                                <button onclick="excluirPedido('${client.id}', '${pedido.id}')" class="text-red-500 hover:underline">Excluir</button>
                            </div>
                        `;
                    }
                    html += `</div></div>`;
                }
                if (html === '') {
                    html = '<p class="text-gray-500 text-center">Nenhum pedido encontrado.</p>';
                }
                listaPedidosElement.innerHTML = html;
                errorMessage.classList.add('hidden');
            } catch (error) {
                errorMessage.textContent = 'Erro ao carregar pedidos: ' + error.message;
                errorMessage.classList.remove('hidden');
                console.error('Erro:', error);
            }
        }

        async function excluirPedido(clientId, pedidoId) {
            if (!confirm('Tem certeza que deseja excluir este pedido?')) return;

            try {
                const response = await fetch(`https://66d39f5c184dce1713d09736.mockapi.io/Api/v1/clientes/${clientId}`);
                const clientData = await response.json();
                const pedidos = clientData.pedidos || [];
                const novosPedidos = pedidos.filter(p => p.id !== pedidoId);
                clientData.pedidos = novosPedidos;
                const updateResponse = await fetch(`https://66d39f5c184dce1713d09736.mockapi.io/Api/v1/clientes/${clientId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clientData)
                });
                if (updateResponse.ok) {
                    carregarPedidos(); // Atualizar a lista em tempo real
                } else {
                    alert('Erro ao excluir pedido.');
                }
            } catch (error) {
                console.error('Erro ao excluir pedido:', error);
                alert('Erro ao excluir pedido.');
            }
        }
    </script>
</body>
</html>